@model sem3.Models.ModelViews.UserM
@{
    ViewBag.Title = "My Account";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/Client/profile.css" rel="stylesheet" />

<!-- Kiểm tra CDN bằng cách thêm trực tiếp -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

@Html.AntiForgeryToken()

<div class="profile-wrapper" data-user-id="@Model.UserID">
    <h2>My Account</h2>

    <div class="profile-info">
        <div class="profile-row">
            <label>Full Name:</label>
            <input id="FullName" class="readonly" value="@Model.FullName" disabled />
        </div>

        <div class="profile-row">
            <label>Mobile Number:</label>
            <input id="MobileNumber" class="readonly" value="@Model.MobileNumber" disabled />
        </div>

        <div class="profile-row">
            <label>Email:</label>
            <input id="Email" class="readonly" value="@Model.Email" disabled />
        </div>

        <div class="profile-row">
            <label>Address:</label>
            <input id="Address" class="readonly" value="@Model.Address" disabled />
        </div>

        <button class="edit-btn" id="editBtn">
            <i class="fas fa-edit"></i> Edit Profile Info
        </button>

        <button class="edit-btn change-password-btn" id="changePasswordBtn">
            <i class="fas fa-key"></i> Change Password
        </button>
    </div>

    <!-- Services Section -->
    <div class="services-section">
        <h3>My Services</h3>

        <!-- Do Not Disturb Service -->
        <div class="service-item">
            <div class="service-info">
                <h4>Do Not Disturb</h4>
                <p>Block promotional calls and messages</p>
            </div>
            <div class="service-actions">
                <span id="doNotDisturbStatus" class="service-status @(ViewBag.DoNotDisturbStatus ? "status-enabled" : "status-disabled")">
                    @(ViewBag.DoNotDisturbStatus ? "Enabled" : "Disabled")
                </span>
                <label class="toggle-switch">
                    <input type="checkbox" id="doNotDisturbToggle" @(ViewBag.DoNotDisturbStatus ? "checked" : "")>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <!-- Caller Tunes Service -->
        <div class="service-item with-preview">
            <div class="service-info">
                <h4>Caller Tunes</h4>
                <p>Customize your call waiting music</p>
                <div class="current-selection">
                    <small>
                        Current: <span id="currentTuneName">
                            @if (ViewBag.SelectedTune == "Default")
                            {
                                <text>Default (No music)</text>
                            }
                            else if (ViewBag.SelectedTune == "Waiting.mp3")
                            {
                                <text>Waiting Music</text>
                            }
                            else if (!string.IsNullOrEmpty(ViewBag.SelectedTune))
                            {
                                <text>My Custom Tune</text>
                            }
                            else
                            {
                                <text>Default (No music)</text>
                            }
                        </span>
                    </small>
                </div>

                <!-- Audio Preview Panel -->
                <div id="tunePreview" class="tune-preview">
                    <div class="preview-header">
                        <h5><i class="fas fa-headphones"></i> Preview</h5>
                        <div class="preview-info">
                            <span id="previewTuneName">-</span>
                            <span id="previewDuration">-</span>
                        </div>
                    </div>
                    <div class="preview-controls">
                        <button id="playPreviewBtn" class="preview-btn btn-play">
                            <i class="fas fa-pause"></i> Pause Preview
                        </button>
                        <button id="stopPreviewBtn" class="preview-btn btn-stop">
                            <i class="fas fa-stop"></i> Canecl
                        </button>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <span class="time-display">
                                <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                            </span>
                        </div>
                        <div class="volume-control">
                            <i class="fas fa-volume-up"></i>
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.7">
                        </div>
                    </div>
                </div>
            </div>

            <div class="service-actions with-preview">
                <!-- Tune Selection Cards -->
                <div class="tune-selection-cards">
                    <!-- Default Option -->
                    <div class="tune-card @(ViewBag.SelectedTune == "Default" ? "selected" : "")" data-tune-value="Default">
                        <div class="tune-card-icon">
                            <i class="fas fa-ban"></i>
                        </div>
                        <div class="tune-card-content">
                            <h5>No Music</h5>
                            <p>Default call waiting</p>
                        </div>
                        <div class="tune-card-check">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>

                    <!-- Waiting Music Option -->
                    <div class="tune-card @(ViewBag.SelectedTune == "Waiting.mp3" ? "selected" : "")" data-tune-value="Waiting.mp3">
                        <div class="tune-card-icon">
                            <i class="fas fa-music"></i>
                        </div>
                        <div class="tune-card-content">
                            <h5>Waiting Music</h5>
                            <p>Classic waiting tone</p>
                        </div>
                        <div class="tune-card-check">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>

                    <!-- Custom Upload Option -->
                    <div class="tune-card upload-card @(ViewBag.SelectedTune != "Default" && ViewBag.SelectedTune != "Waiting.mp3" && !string.IsNullOrEmpty(ViewBag.SelectedTune) ? "selected" : "")"
                         data-tune-value="@(ViewBag.SelectedTune != "Default" && ViewBag.SelectedTune != "Waiting.mp3" && !string.IsNullOrEmpty(ViewBag.SelectedTune) ? ViewBag.SelectedTune : "upload")">
                        <div class="tune-card-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="tune-card-content">
                            @if (ViewBag.SelectedTune != "Default" && ViewBag.SelectedTune != "Waiting.mp3" && !string.IsNullOrEmpty(ViewBag.SelectedTune))
                            {
                                <h5>My Custom Tune</h5>
                                <p>Your uploaded music</p>
                                <div class="file-actions">
                                    <button class="replace-btn" data-tune-value="@ViewBag.SelectedTune">
                                        <i class="fas fa-sync"></i> Replace
                                    </button>
                                    <button class="remove-btn" data-tune-value="@ViewBag.SelectedTune">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            }
                            else
                            {
                                <h5>Upload Your Music</h5>
                                <p>Use your own MP3 file</p>
                            }
                        </div>
                        <div class="tune-card-check">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div id="fileUploadSection" class="file-upload-section" style="display: none;">
                    <div class="upload-header">
                        <h5><i class="fas fa-upload"></i> Upload Your Music</h5>
                        <button class="close-upload" id="closeUploadBtn">&times;</button>
                    </div>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-placeholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop your MP3 file here</p>
                            <span>or</span>
                            <button class="browse-btn" id="browseBtn">Browse Files</button>
                            <input type="file" id="tuneFileInput" accept=".mp3" style="display: none;" />
                        </div>
                    </div>

                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="file-details">
                            <i class="fas fa-file-audio"></i>
                            <div class="file-meta">
                                <span id="fileName" class="file-name"></span>
                                <span id="fileSize" class="file-size"></span>
                            </div>
                        </div>
                        <button id="uploadTuneBtn" class="service-btn btn-upload">
                            <i class="fas fa-upload"></i> Upload & Set
                        </button>
                    </div>

                    <div class="upload-validation">
                        <small><i class="fas fa-info-circle"></i> Only MP3 files, max 10MB. This will replace your current custom tune.</small>
                    </div>
                </div>             
                <!-- Action Buttons -->
                <div class="action-buttons" id="actionButtons" style="display: none;">
                    <button id="saveTuneBtn" class="service-btn btn-save">
                        <i class="fas fa-check"></i> Save Changes
                    </button>
                    <button id="cancelTuneBtn" class="service-btn btn-cancel">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/profile.js"></script>
<script>
    // Initialize services when document is ready
    $(document).ready(function() {
        initializeServices(
            @Json.Encode(ViewBag.DoNotDisturbStatus),
            '@ViewBag.SelectedTune',
            @Json.Encode(ViewBag.CallerTunesStatus)
        );
    });
</script>